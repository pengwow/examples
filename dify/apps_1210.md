# 基于Dify平台的邮件分析提示词设计

## 1. 前置动作

在调用Dify API前，需要从邮件系统中提取以下4个字段：
- **标题**：邮件的主题行
- **发送人**：邮件的发件人信息（包含邮箱地址）
- **邮件正文**：邮件的主要内容
- **uid**：邮件的唯一标识符

## 2. 分析类型定义

Dify将根据邮件内容分析出以下类型：

| 分析类型 | 描述 |
|---------|------|
| 关注 | 需要重点关注的数据，如重要通知、会议提醒等 |
| 审批建议 | 需要审批的数据，提供决策参考，格式为：采1、采2... |
| 不处理 | 敏感的数据，识别需保护内容，如个人隐私、财务数据等 |
| 正文总结 | 提取邮件核心信息，简洁明了 |

## 3. 分层提示词结构

### 3.1 SYSTEM角色提示词

```
你是一位专业的邮件分析助手，负责根据给定的邮件信息进行分类、分析和总结。

## 分析类型定义
- **关注**: 需要关注的数据，如重要通知、会议提醒、关键项目更新等
- **审批建议**: 需要审批的数据，提供决策参考，如采购申请、报销审批、请假申请等
- **不处理**: 敏感的数据，如个人隐私信息、财务数据、机密文件等需要保护的内容
- **正文总结**: 提取邮件核心信息，简洁明了

## 输出格式要求
请严格按照以下JSON格式输出，不得添加任何额外内容：
{
  "uid": "邮件唯一标识符",
  "title": "邮件标题",
  "sender": "邮件发送人",
  "analysis_type": "分析类型，取值为：关注、审批建议、不处理",
  "approval_suggestions": ["审批建议列表，仅当analysis_type为审批建议时必填"],
  "content_summary": "邮件正文核心总结",
  "sensitive_content": "识别到的敏感内容，仅当analysis_type为不处理时必填"
}

## 规则和约束
1. 请确保分析类型准确，严格按照定义分类
2. 审批建议需清晰、具体，编号格式为：采1、采2...
3. 内容总结需提取核心信息，避免冗余
4. 敏感内容需明确指出具体的敏感信息类型
5. 所有字段必须填写，不得留空
6. 仅当analysis_type为审批建议时，approval_suggestions字段为必填数组
7. 仅当analysis_type为不处理时，sensitive_content字段为必填字符串
8. 其他情况下，非必填字段可以为空数组或空字符串
```

### 3.2 USER角色提示词

```
请根据以下邮件信息进行分析：

邮件标题：{{title}}
发送人：{{sender}}
邮件正文：{{content}}
邮件UID：{{uid}}

请按照要求分析该邮件，并输出符合格式要求的JSON。
```

### 3.3 ASSISTANT输出示例

```json
{
  "uid": "20240615_001",
  "title": "关于2024年Q3项目预算审批的通知",
  "sender": "财务部 <finance@company.com>",
  "analysis_type": "审批建议",
  "approval_suggestions": ["采1：确认预算总额是否符合部门规划", "采2：审核预算分配是否合理", "采3：确保在规定时间内完成审批"],
  "content_summary": "财务部通知部门经理于本周五前完成2024年Q3项目预算（总额150万元）的审批，预算主要用于新产品研发和市场推广。",
  "sensitive_content": ""
}
```

## 4. 完整API调用示例

### 4.1 Python代码示例

```python
import requests
import json

class DifyMailAnalyzer:
    """
    Dify邮件分析器，用于调用Dify API分析邮件内容
    
    参数：
    - api_key: Dify平台的API密钥
    - model: 使用的Dify模型名称
    
    方法：
    - analyze_mail: 分析单封邮件
    - analyze_mails: 批量分析邮件
    """
    
    def __init__(self, api_key, model="gpt-4-turbo"):
        """
        初始化Dify邮件分析器
        
        参数：
        - api_key: Dify平台的API密钥
        - model: 使用的Dify模型名称，默认为gpt-4-turbo
        """
        self.api_key = api_key
        self.model = model
        self.url = "https://api.dify.ai/v1/chat/completions"
        self.headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }
    
    def analyze_mail(self, mail_data):
        """
        分析单封邮件
        
        参数：
        - mail_data: 邮件数据字典，包含title、sender、content、uid字段
        
        返回：
        - dict: 分析结果JSON字典
        
        异常：
        - requests.exceptions.RequestException: API请求失败时抛出
        - json.JSONDecodeError: 解析API响应失败时抛出
        """
        # SYSTEM提示词
        system_prompt = "你是一位专业的邮件分析助手..."  # 完整SYSTEM提示词见3.1节
        
        # USER提示词模板
        user_prompt = f"""请根据以下邮件信息进行分析：

邮件标题：{mail_data['title']}
发送人：{mail_data['sender']}
邮件正文：{mail_data['content']}
邮件UID：{mail_data['uid']}

请按照要求分析该邮件，并输出符合格式要求的JSON。"""
        
        # 构建请求数据
        data = {
            "model": self.model,
            "messages": [
                {
                    "role": "system",
                    "content": system_prompt
                },
                {
                    "role": "user",
                    "content": user_prompt
                }
            ],
            "response_format": {"type": "json_object"}
        }
        
        # 发送API请求
        response = requests.post(self.url, headers=self.headers, data=json.dumps(data))
        response.raise_for_status()
        
        # 解析响应
        result = response.json()
        return json.loads(result['choices'][0]['message']['content'])
    
    def analyze_mails(self, mail_list):
        """
        批量分析邮件
        
        参数：
        - mail_list: 邮件数据字典列表
        
        返回：
        - list: 分析结果JSON字典列表
        
        异常：
        - requests.exceptions.RequestException: API请求失败时抛出
        - json.JSONDecodeError: 解析API响应失败时抛出
        """
        results = []
        for mail_data in mail_list:
            result = self.analyze_mail(mail_data)
            results.append(result)
        return results

# 使用示例
if __name__ == "__main__":
    # 初始化分析器
    analyzer = DifyMailAnalyzer(api_key="YOUR_API_KEY")
    
    # 示例邮件数据
    mail_data = {
        "title": "关于2024年Q3项目预算审批的通知",
        "sender": "财务部 <finance@company.com>",
        "content": "尊敬的部门经理，您好！附件是2024年Q3项目预算草案，请您于本周五前完成审批。本次预算总额为150万元，主要用于新产品研发和市场推广。如有疑问，请联系财务部李经理。",
        "uid": "20240615_001"
    }
    
    # 分析邮件
    result = analyzer.analyze_mail(mail_data)
    print(json.dumps(result, ensure_ascii=False, indent=2))
```

## 5. 输出JSON结构定义

| 字段名 | 类型 | 描述 | 必填 |
|-------|------|------|------|
| uid | string | 邮件唯一标识符 | 是 |
| title | string | 邮件标题 | 是 |
| sender | string | 邮件发送人 | 是 |
| analysis_type | string | 分析类型（关注、审批建议、不处理） | 是 |
| approval_suggestions | array | 审批建议列表，格式为：采1、采2... | 否（仅当analysis_type为审批建议时必填） |
| content_summary | string | 邮件正文核心总结 | 是 |
| sensitive_content | string | 识别到的敏感内容 | 否（仅当analysis_type为不处理时必填） |

## 6. 示例输出

### 6.1 审批建议类型示例

```json
{
  "uid": "20240615_001",
  "title": "关于2024年Q3项目预算审批的通知",
  "sender": "财务部 <finance@company.com>",
  "analysis_type": "审批建议",
  "approval_suggestions": ["采1：确认预算总额150万元是否符合部门规划", "采2：审核预算分配是否合理，重点关注新产品研发和市场推广的比例", "采3：确保在本周五前完成审批并反馈"],
  "content_summary": "财务部通知部门经理于本周五前完成2024年Q3项目预算（总额150万元，用于新产品研发和市场推广）的审批，如有疑问联系李经理。",
  "sensitive_content": ""
}
```

### 6.2 关注类型示例

```json
{
  "uid": "20240615_002",
  "title": "紧急会议通知",
  "sender": "CEO办公室 <ceo@company.com>",
  "analysis_type": "关注",
  "approval_suggestions": [],
  "content_summary": "CEO办公室通知全体部门经理明天上午10点在会议室召开紧急会议，讨论公司战略调整，请准时参加。",
  "sensitive_content": ""
}
```

### 6.3 不处理类型示例

```json
{
  "uid": "20240615_003",
  "title": "员工工资明细",
  "sender": "人力资源部 <hr@company.com>",
  "analysis_type": "不处理",
  "approval_suggestions": [],
  "content_summary": "人力资源部发送2024年5月员工工资明细，包含基本工资、绩效奖金、社保公积金等信息。",
  "sensitive_content": "包含员工个人工资明细，属于敏感财务信息，需严格保密。"
}
```

## 7. 验证步骤

### 7.1 结构验证

1. **JSON格式验证**：使用JSON验证工具（如https://jsonlint.com/）验证输出是否为有效的JSON格式
2. **必填字段验证**：检查所有必填字段（uid、title、sender、analysis_type、content_summary）是否存在且不为空
3. **字段类型验证**：检查各字段类型是否符合定义（如approval_suggestions必须为数组）

### 7.2 内容验证

1. **分析类型验证**：检查analysis_type是否为允许的值（关注、审批建议、不处理）
2. **审批建议验证**：当analysis_type为审批建议时，检查approval_suggestions是否为非空数组，且格式符合要求（采1、采2...）
3. **敏感内容验证**：当analysis_type为不处理时，检查sensitive_content是否为非空字符串，且准确描述了敏感内容类型
4. **内容总结验证**：检查content_summary是否准确提取了邮件核心信息，无冗余内容

### 7.3 完整性验证

1. **输入字段传递验证**：检查输出中的uid、title、sender是否与输入一致
2. **分析结果合理性验证**：检查分析类型和内容是否符合邮件实际内容
3. **无遗漏信息验证**：检查是否有重要信息被遗漏

## 8. 应用场景扩展

### 8.1 自动分类归档
根据analysis_type将邮件自动分类归档到不同文件夹，提高邮件管理效率

### 8.2 审批流程集成
将审批建议自动推送到企业审批系统，加速审批流程，减少人工干预

### 8.3 敏感信息保护
识别敏感内容并自动标记或加密，防止信息泄露

### 8.4 智能提醒
对重要的关注类邮件发送提醒通知，确保及时处理

### 8.5 数据分析统计
定期统计邮件分析结果，生成报告，为企业决策提供参考

## 9. 优化建议

1. **定期更新提示词**：根据实际业务场景和反馈，定期优化SYSTEM提示词和分析类型定义
2. **结合业务规则**：根据企业具体业务规则调整审批建议的生成规则
3. **机器学习优化**：结合机器学习模型，提高分类准确性和分析效率
4. **多维度分析**：添加更多分析维度，如优先级、紧急程度、关联项目等
5. **多语言支持**：支持中文、英文等多种语言的邮件分析
6. **附件分析**：扩展支持邮件附件的分析，如PDF、Word文档等

## 10. 测试用例

### 10.1 测试用例1：审批建议类型

**输入**：
```
{
  "title": "关于购买新办公设备的申请",
  "sender": "行政部 <admin@company.com>",
  "content": "尊敬的领导，您好！由于现有办公设备老化，影响工作效率，申请购买10台新电脑，预算总额为5万元。请审批。",
  "uid": "20240615_004"
}
```

**预期输出**：
```json
{
  "uid": "20240615_004",
  "title": "关于购买新办公设备的申请",
  "sender": "行政部 <admin@company.com>",
  "analysis_type": "审批建议",
  "approval_suggestions": ["采1：核实现有办公设备老化情况", "采2：确认10台新电脑的数量是否合理", "采3：审核5万元预算是否符合公司采购标准"],
  "content_summary": "行政部申请购买10台新电脑，预算5万元，用于替换老化设备，提高工作效率。",
  "sensitive_content": ""
}
```

### 10.2 测试用例2：关注类型

**输入**：
```
{
  "title": "项目进度报告",
  "sender": "项目经理 <pm@company.com>",
  "content": "各位项目成员，本周项目进度达到80%，预计下周可以完成全部开发工作。请各小组注意测试环节，确保项目质量。",
  "uid": "20240615_005"
}
```

**预期输出**：
```json
{
  "uid": "20240615_005",
  "title": "项目进度报告",
  "sender": "项目经理 <pm@company.com>",
  "analysis_type": "关注",
  "approval_suggestions": [],
  "content_summary": "项目经理通报项目进度达到80%，预计下周完成全部开发工作，要求各小组注意测试环节，确保项目质量。",
  "sensitive_content": ""
}
```

### 10.3 测试用例3：不处理类型

**输入**：
```
{
  "title": "客户隐私数据处理报告",
  "sender": "法务部 <legal@company.com>",
  "content": "尊敬的领导，附件是客户隐私数据处理报告，包含客户姓名、身份证号、联系方式等敏感信息。请严格保密，仅用于内部审计。",
  "uid": "20240615_006"
}
```

**预期输出**：
```json
{
  "uid": "20240615_006",
  "title": "客户隐私数据处理报告",
  "sender": "法务部 <legal@company.com>",
  "analysis_type": "不处理",
  "approval_suggestions": [],
  "content_summary": "法务部发送客户隐私数据处理报告，包含客户姓名、身份证号、联系方式等敏感信息，要求严格保密。",
  "sensitive_content": "包含客户姓名、身份证号、联系方式等个人隐私信息，属于需要严格保护的敏感数据。"
}
```

## 11. 总结

本设计提供了一套完整的基于Dify平台的邮件分析提示词方案，包括：

1. 清晰的前置动作定义，明确需要传递的邮件字段
2. 详细的分析类型定义，覆盖实际业务场景
3. 分层的提示词结构，利用SYSTEM角色定义规则，USER角色明确任务
4. 规范的JSON输出格式，确保数据结构统一
5. 完整的代码示例，便于集成到实际系统中
6. 全面的验证步骤，确保输出质量
7. 丰富的应用场景扩展，满足不同业务需求
8. 实用的优化建议，便于后续迭代改进
9. 详细的测试用例，验证设计的有效性

通过这套方案，可以实现高效、准确的邮件分析，提高企业邮件处理效率，降低人工成本，同时保护敏感信息安全。