# NiceVibes - Project Rules

Rules for AI agents (like Cascade) working on this repository.

This file is **not** part of the master prompt. It governs how to maintain and extend the documentation and samples in this project.

---

## Project Overview

This repository contains documentation and examples to help AI agents generate correct NiceGUI code. The main output is `output/nice_vibes.md` - a single file containing all documentation for context injection.

## File Organization

```
docs/
├── nicegui_prompt.md       # Main guide (always first in master prompt)
├── mechanics/              # Core patterns (application structure, pages, etc.)
├── events/                 # Event handling documentation
├── classes/                # UI element reference by category
│   ├── *.md                # Class docs (included in master prompt)
│   └── *_references.md     # Source URLs (excluded from master prompt)
└── prompt_config.yaml      # Controls master prompt build order

nice_vibes/                 # Python package
├── cli.py                  # Command-line interface (nice-vibes command)
└── mcp/                    # MCP server for AI assistant integration

samples/                    # Working example applications
scripts/                    # Build and validation tools
tests/                      # Pytest tests
output/                     # Generated master prompts (compact/optimum/extended)
```

**Generated files (DO NOT EDIT directly):**
- `README.md` - generated from `docs/README_template.md` via `scripts/build_readme.py`
- `README_PYPI.md` - generated from template via `scripts/build_pypi_readme.py`
- `samples/README.md` - generated from `samples/README_template.md` via `scripts/build_samples_gallery.py`

## MCP Server

The optional MCP server (`nice_vibes/mcp/`) provides AI assistants with:
- Documentation search without loading everything into context
- NiceGUI component source code inspection
- Screenshot capture of running applications (JPEG/PNG with quality options)
- Sample exploration and copying
- Project setup with `single_page` and `spa` templates

See `nice_vibes/mcp/README.md` for setup instructions.

## Environment

This project is a poetry project. Use `poetry install` to install dependencies.

## Common Commands

```bash
# Install dependencies
poetry install

# Run tests (do NOT pipe output - we need to see results)
poetry run pytest -v

# Run a sample application
poetry run python samples/dashboard/main.py

# Build master prompt (outputs to output/)
poetry run python scripts/build_master_prompt.py

# Build everything (screenshots, gallery, GIFs, prompts)
poetry run python scripts/build_all.py
poetry run python scripts/build_all.py --skip-screenshots

# Validate class references
poetry run python scripts/validate_classes.py
poetry run python scripts/validate_classes.py --check-urls

# Generate class reference files
poetry run python scripts/generate_class_references.py

# Build samples gallery (uses samples/README_template.md)
poetry run python scripts/build_samples_gallery.py

# Capture screenshots
poetry run python scripts/capture_screenshots.py
poetry run python scripts/capture_screenshots.py dashboard

# Verify project templates create working applications (includes screenshot capture)
poetry run python scripts/verify_project_templates.py
poetry run python scripts/verify_project_templates.py --type spa
poetry run python scripts/verify_project_templates.py --keep  # Keep temp dirs for inspection
poetry run python scripts/verify_project_templates.py --no-screenshot  # Skip screenshots (faster)
```

## Maintenance Rules

### When Adding Documentation

1. Add new files to the appropriate `docs/` subdirectory
2. Update `docs/prompt_config.yaml` to include the file in the correct order
3. Rebuild the master prompt: `poetry run python scripts/build_master_prompt.py`

### When Modifying Class References

1. Edit the class file in `docs/classes/`
2. Regenerate reference files: `poetry run python scripts/generate_class_references.py`
3. Validate: `poetry run python scripts/validate_classes.py`

### When Adding or Modifying Samples

**Files that MUST be updated when adding/renaming/modifying samples:**

1. **Sample files**:
   - `main.py` - Application entry point
   - `README.md` - Title, description, features, patterns demonstrated
   - `screenshot.jpg` - Generated by `scripts/capture_screenshots.py`

2. **Project index files** (update ALL of these):
   - `docs/prompt_config.yaml` - Add/update sample entry with summary
   - `docs/nicegui_prompt.md` - Update if sample demonstrates new mechanics
   - `samples/README.md` - Auto-generated, run `scripts/build_samples_gallery.py`

3. **Related documentation**:
   - Update relevant `docs/mechanics/*.md` if sample demonstrates new patterns
   - Add cross-references in "See Also" sections

Sample guidelines:
- Use OO architecture with `Dashboard`/`App` class and `current()` classmethod
- Store per-user state in `app.storage.client`
- Always use `ui.run(show=False, title='...')` in the main guard

For animated samples (e.g., video processing, tornado):
- Add `<!-- animated -->` marker in README.md
- Use `![Animation](animated.gif)` in the README instead of screenshot.jpg
- The gallery will show a live-recorded GIF instead of static screenshot

### Samples Gallery

The gallery in `samples/README.md` is auto-generated:

```bash
# Rebuild gallery and showcase GIF
poetry run python scripts/build_samples_gallery.py

# Capture/update screenshots (all or specific)
poetry run python scripts/capture_screenshots.py
poetry run python scripts/capture_screenshots.py dashboard
```

Gallery features:
- Auto-discovers samples from `samples/*/README.md`
- Generates `samples/showcase.gif` for main README
- Animated samples get `animated.gif` recorded at 20 FPS for 3 seconds
- Static samples show `screenshot.jpg` for 2.5 seconds in showcase

### Keep README.md Current

Update `README.md` when:
- Adding new files or directories
- Changing project structure
- Adding new scripts or tools

### Keep nicegui_prompt.md Current

Update `docs/nicegui_prompt.md` when:
- Adding new documentation sections
- Documenting new patterns or mechanics
- Adding important rules or gotchas

## Build All

Rebuild everything (screenshots, gallery, GIFs, prompts):

```bash
poetry run python scripts/build_all.py

# Skip slow screenshot capture
poetry run python scripts/build_all.py --skip-screenshots
```

## Master Prompt Build

The master prompt is built from all documentation files in the order specified by `docs/prompt_config.yaml`.

Three variants are generated in `output/`:

| Variant | Tokens | Use Case |
|---------|--------|----------|
| **Compact** | ~14K | Quick tasks, simple UI |
| **Optimum** | ~23K | Most use cases |
| **Extended** | ~34K | Custom components, deployment |

### Configuration

Edit `docs/prompt_config.yaml` to control:
- **File order** - Priority order for each section
- **Exclusions** - Files to skip (e.g., `*_references.md`)

### Building

```bash
poetry run python scripts/build_master_prompt.py
```

Options:
- `--github-url URL` - Set GitHub URL for source links (default: https://github.com/Alyxion/nice-vibes)

## Validation

Run before committing:

```bash
# Validate class references
poetry run python scripts/validate_classes.py

# Also check URLs
poetry run python scripts/validate_classes.py --check-urls
```

## Class Reference Structure

Each class category file has a corresponding `*_references.md` with:
- **Description** - What the class does
- **Inherits** - Base class chain (important for event handling)
- **Source** - Link to GitHub source code
- **Documentation** - Link to nicegui.io docs

### Important Base Classes

Track these in the Inherits column:
- `ui.element` - Base for all UI elements
- `ValueElement` - Elements with `.value` and `on_change`
- `DisableableElement` - Elements that can be disabled
- `ContentElement` - Elements with text/HTML content
- `SourceElement` - Elements with source (images, audio, video)
- `ChoiceElement` - Selection elements (radio, select, toggle)
- `ValidationElement` - Input elements with validation

## NiceGUI Code Conventions

When writing samples or examples, follow these patterns:

### Main Guard

```python
if __name__ in {'__main__', '__mp_main__'}:
    ui.run(show=False, title='My App')
```

### Port 8080

NEVER change the port. Always use port 8080. If port is in use, kill the existing process first.

### Hot Reload for Static Files

Include JS/CSS in reload watch:

```python
ui.run(
    root,
    reload=True,
    uvicorn_reload_includes='*.py,*.js,*.css',
)
```

### Per-User Data

Never use global variables. Use `app.storage.client`:

```python
@dataclass
class UserData:
    name: str = ''
    
    @classmethod
    def current(cls) -> 'UserData':
        if 'user_data' not in app.storage.client:
            app.storage.client['user_data'] = cls()
        return app.storage.client['user_data']
```

### File Organization for SPAs

For SPA applications with `ui.sub_pages`:

```
my_app/
├── main.py         # Server setup only (static files, page discovery, ui.run)
├── layout.py       # AppLayout class (header, drawer, routing, auth checks)
├── auth.py         # AuthSession dataclass, USERS, ROLE_PERMISSIONS
├── pages/
│   ├── home/
│   │   ├── __init__.py   # Exports only: from .home import HomePage
│   │   └── home.py       # Implementation
│   └── ...
└── static/
    ├── css/
    │   └── app.css
    └── js/
        └── app.js
```

Key principles:
- **`__init__.py` exports only** - No implementation code
- **Name files after content** - `home.py` not `page.py` or `dashboard.py`
- **Separate layout from server setup** - `main.py` stays minimal

### Container Updates

```python
container.clear()
with container:
    ui.label('New content')
```

Or use `@ui.refreshable` for simpler cases.

## Deployment

### Version Bump

Update version in `pyproject.toml` before releasing.

### Build and Test Workflow

```bash
# 1. Run tests
poetry run pytest -v

# 2. Verify project templates work
poetry run python scripts/verify_project_templates.py

# 3. Build the wheel
./scripts/build.sh              # Quick build
./scripts/build.sh --full       # Rebuild READMEs and prompts first

# 4. Test the wheel in isolated environment
./scripts/test_wheel.sh

# 5. Deploy to PyPI
./scripts/deploy_pypi.sh        # Production
./scripts/deploy_pypi.sh --test # TestPyPI first (recommended)
```

### What the Scripts Do

- **`build.sh`** - Cleans dist/, builds wheel with `poetry build`
- **`build.sh --full`** - Also rebuilds README.md and master prompts
- **`test_wheel.sh`** - Creates temp venv, installs wheel, runs smoke tests (CLI, imports)
- **`deploy_pypi.sh`** - Publishes to PyPI (requires PYPI_TOKEN)
- **`deploy_pypi.sh --test`** - Publishes to TestPyPI first

## Rule Placement

**Mechanic-specific rules belong in the relevant `docs/mechanics/` files**, not here. This file only covers general project maintenance principles.

Examples:
- Port conflict handling → `docs/mechanics/configuration_deployment.md`
- Routing patterns → `docs/mechanics/routing.md`
- Authentication patterns → `docs/mechanics/authentication.md`
